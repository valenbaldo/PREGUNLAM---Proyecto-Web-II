<style>
    :root{
        --brand:#0b8f72;
        --ink:#0b0b0b;
        --muted:#6b7280;
        --card:#ffffff;
        --ring:#e5e7eb;
        --bg:#f3f4f6;
    }
    body{ background:var(--bg); margin:0; padding:0; height:100vh; overflow:hidden; display:flex; flex-direction:column; }

    .adm-wrap{ max-width:100%; flex:1; margin:0; padding:6px; display:flex; flex-direction:column; box-sizing:border-box; }
    .adm-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:6px; flex-wrap:wrap; }
    .adm-title{ font-size:20px; font-weight:900; display:flex; align-items:center; gap:8px; }
    .adm-title i{ width:28px; height:28px; display:inline-grid; place-items:center; background:var(--brand); color:#fff; border-radius:8px; }

    .adm-actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn{ border:none; border-radius:12px; padding:10px 14px; background:#111; color:#fff; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; gap:8px; }
    .btn.outline{ background:#fff; color:var(--ink); border:1px solid var(--ring); }
    .btn.brand{ background:var(--brand); }
    .btn.small{ padding:7px 11px; border-radius:10px; font-size:14px; }

    .selector{ padding:7px 11px; border-radius:10px; border:1px solid var(--ring); background:#fff; color:var(--ink); font-size:14px; cursor:pointer; }
    .selector:focus{ outline:none; border-color:var(--brand); }

    .chip{ padding:6px 10px; border-radius:999px; border:1px solid var(--ring); background:#fff; color:var(--ink); font-size:13px; }
    .chip.active{ background:var(--brand); color:#fff; border-color:var(--brand); }

    .adm-kpis{ display:grid; grid-template-columns:repeat(4,1fr); gap:6px; margin-bottom:6px; }
    @media (max-width:1000px){ .adm-kpis{ grid-template-columns:repeat(2,1fr);} }
    @media (max-width:640px){ .adm-kpis{ grid-template-columns:1fr;} }

    .card{ background:var(--card); border:1px solid var(--ring); border-radius:6px; padding:8px; }
    .kpi{ display:flex; align-items:center; gap:12px; }
    .kpi i{ width:40px; height:40px; border-radius:12px; display:grid; place-items:center; background:#eef8f5; color:var(--brand); font-size:18px; }
    .kpi .kpi-label{ font-size:11px; color:var(--muted); margin-bottom:1px; }
    .kpi .kpi-value{ font-weight:900; font-size:20px; line-height:1; }
    .kpi.reporte i { background: #fee2e2; color: #dc2626; }

    .main-content{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px; flex:1; min-height:0; }
    @media (max-width:1200px){ .main-content{ grid-template-columns:1fr; } }
    
    .chart-container{ position:relative; height:180px; width:100%; margin:3px 0; }
    .chart-container canvas{ max-height:100% !important; }
    
    .chart-item{ height:100%; display:flex; flex-direction:column; }
    .chart-item .card{ height:100%; display:flex; flex-direction:column; }
    .chart-item .chart-container{ flex:1; height:auto; min-height:150px; }
    .chart-item table{ height:100%; }
    .tables-section{ display:flex; flex-direction:column; gap:12px; }
    .tables-section .card{ min-height:200px; }
    .tables-section .tbl{ font-size:13px; }
    
    .adm-grid{ display:grid; grid-template-columns:2fr 1fr; gap:14px; }
    @media (max-width:1000px){ .adm-grid{ grid-template-columns:1fr; } }

    .tbl{ width:100%; border-collapse:collapse; }
    .tbl th,.tbl td{ padding:6px 8px; border-bottom:1px solid var(--ring); font-size:12px; }
    .tbl th{ background:#f9fafb; text-align:left; color:#111; font-weight:700; }
    .tbl td.muted{ color:var(--muted); }

    .card h3{ font-weight:800; font-size:16px; margin-bottom:10px; display:flex; align-items:center; gap:8px; }
    .subcard{ background:var(--card); border:1px solid var(--ring); border-radius:16px; padding:12px; }
    .stack &gt * + *{ margin-top:12px; }


    @media print{
        .adm-actions, .chip, .btn{ display:none !important; }
        .adm-wrap{ max-width:none; margin:0; padding:0; }
        body{ background:#fff; }
        .card, .subcard{ border:1px solid #000; }
    }

</style>

<div class="adm-wrap">

    <div class="adm-head">
        <div class="adm-title">
            <i>üìä</i> <span>Panel de Administraci√≥n</span>
        </div>

        <div class="adm-actions">
            <a class="btn brand small" href="/admin/gestionarReportes" title="Revisar Reportes Pendientes">üîî Reportes ({{stats.reportes_pendientes}})</a>
            <a class="btn brand small" href="/admin/gestionarUsuarios">üë• Gesti√≥n de Usuarios</a>



            <button class="btn outline small" onclick="descargarPDF()">üìã Descargar PDF</button>
        </div>
    </div>


    <div class="adm-kpis">
        <div class="card kpi">
            <i>üë•</i>
            <div>
                <div class="kpi-label">Usuarios Totales</div>
                <div class="kpi-value">{{stats.usuarios_totales}}</div>
            </div>
        </div>

        <div class="card kpi">
            <i>üéÆ</i>
            <div>
                <div class="kpi-label">Partidas Jugadas</div>
                <div class="kpi-value">{{stats.partidas}}</div>
            </div>
        </div>

        <div class="card kpi reporte">
            <i>üîî</i>
            <div>
                <div class="kpi-label">Reportes Pendientes</div>
                <div class="kpi-value">{{stats.reportes_pendientes}}</div>
            </div>
        </div>

        <div class="card kpi">
            <i>‚ùì</i>
            <div>
                <div class="kpi-label">Preguntas Totales</div>
                <div class="kpi-value">{{stats.preguntas_totales}}</div>
            </div>
        </div>

    </div>

    <div class="content-grid">


    </div>

    <div class="main-content">
        <div class="card chart-item">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0; font-size:16px;">üìä Partidas</h3>
                <div style="display:flex; gap:8px; align-items:center;">
                    <select id="filtroSelector" onchange="cambiarFiltro()" style="padding:4px 6px; font-size:11px; border:1px solid #ddd; border-radius:3px;">
                        <option value="mes">Por Mes</option>
                        <option value="dia">Por D√≠a</option>
                    </select>
                    <select id="monthSelector" onchange="aplicarFiltro()" style="padding:4px 6px; font-size:11px; border:1px solid #ddd; border-radius:3px; display:none;">
                        <option value="1">Enero</option>
                        <option value="2">Febrero</option>
                        <option value="3">Marzo</option>
                        <option value="4">Abril</option>
                        <option value="5">Mayo</option>
                        <option value="6">Junio</option>
                        <option value="7">Julio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="partidasChart"></canvas>
            </div>
        </div>

        <div class="card chart-item">
            <h3 style="font-size:16px;">üé® Preguntas por Categor√≠a</h3>
            <div class="chart-container">
                <canvas id="preguntasCategoriaChart"></canvas>
            </div>
        </div>

        <div class="card chart-item">
            <h3 style="font-size:16px;">üèÜ Rendimiento por Categor√≠a</h3>
            <table class="tbl">
                <thead>
                <tr>
                    <th>Categor√≠a</th>
                    <th>Total Respuestas</th>
                    <th>Aciertos</th>
                    <th>% Acierto</th>
                </tr>
                </thead>
                <tbody>
                {{#rendimientoPorCategoria}}
                    <tr>
                        <td><b>{{categoria}}</b></td>
                        <td class="muted">{{total_respuestas}}</td>
                        <td class="muted">{{aciertos}}</td>
                        <td><b>{{porcentaje_acierto}}%</b></td>
                    </tr>
                {{/rendimientoPorCategoria}}
                {{^rendimientoPorCategoria}}
                    <tr><td colspan="4" class="muted">Sin datos de rendimiento para mostrar.</td></tr>
                {{/rendimientoPorCategoria}}
                </tbody>
            </table>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>

function cambiarFiltro() {
    const filtro = document.getElementById('filtroSelector').value;
    const monthSelector = document.getElementById('monthSelector');
    
    if (filtro === 'dia') {
        monthSelector.style.display = 'block';
    } else {
        monthSelector.style.display = 'none';
    }
    
    aplicarFiltro();
}

function aplicarFiltro() {
    sessionStorage.setItem('navegacionFiltro', 'true');
    
    const filtro = document.getElementById('filtroSelector').value;
    const month = document.getElementById('monthSelector').value;
    
    let url = '?controller=admin&method=base';
    if (filtro) url += `&filtro=${filtro}`;
    if (month && filtro === 'dia') url += `&month=${month}`;
    
    window.location.href = url;
}

document.addEventListener('DOMContentLoaded', function() {
    const esNavegacionFiltro = sessionStorage.getItem('navegacionFiltro');
    
    if (!esNavegacionFiltro) {
        document.getElementById('filtroSelector').value = 'mes';
        document.getElementById('monthSelector').value = new Date().getMonth() + 1;
        document.getElementById('monthSelector').style.display = 'none';
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('filtro') || urlParams.has('month')) {
            window.location.href = '?controller=admin&method=base';
            return;
        }
    } else {
        const filtroActual = '{{filtroSeleccionado}}' || 'mes';
        const monthActual = '{{monthSeleccionado}}' || new Date().getMonth() + 1;
        
        document.getElementById('filtroSelector').value = filtroActual;
        document.getElementById('monthSelector').value = monthActual;
        
        if (filtroActual === 'dia') {
            document.getElementById('monthSelector').style.display = 'block';
        }
        
        sessionStorage.removeItem('navegacionFiltro');
    }

    const partidasData = {{{partidasDataJson}}};
    if (partidasData && partidasData.length > 0) {
        const ctxPartidas = document.getElementById('partidasChart').getContext('2d');
        const filtroActualPagina = '{{filtroSeleccionado}}' || 'mes';
        let labels, titulo;
        if (filtroActualPagina === 'dia') {
            labels = partidasData.map(item => item.dia);
            titulo = 'Partidas por D√≠a';
        } else {
            labels = partidasData.map(item => item.nombre_mes);
            titulo = 'Partidas por Mes';
        }
        const maxValue = Math.max(...partidasData.map(item => item.cantidad));
        const chartType = filtroActualPagina === 'dia' ? 'line' : 'bar';
        const aspectRatio = filtroActualPagina === 'dia' ? 1.5 : 2;
        const maxY = filtroActualPagina === 'dia' ? Math.max(10, maxValue + 2) : 30;
        
        const chartConfig = {
            type: chartType,
            data: {
                labels: labels,
                datasets: [{
                    label: titulo,
                    data: partidasData.map(item => item.cantidad),
                    borderColor: '#0f9d79',
                    backgroundColor: filtroActualPagina === 'dia' ? 'rgba(15, 157, 121, 0.1)' : 'rgba(15, 157, 121, 0.1)',
                    borderWidth: filtroActualPagina === 'dia' ? 4 : 3,
                    fill: true,
                    tension: filtroActualPagina === 'dia' ? 0.4 : 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: aspectRatio,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        min: 0,
                        max: maxY,
                        ticks: {
                            stepSize: filtroActualPagina === 'dia' ? 1 : 2
                        },
                        grid: { color: '#f3f4f6' }
                    },
                    x: {
                        grid: { display: filtroActualPagina === 'dia' ? true : false },
                        ticks: {
                            maxRotation: filtroActualPagina === 'dia' ? 0 : 45,
                            minRotation: filtroActualPagina === 'dia' ? 0 : 45,
                            autoSkip: false,
                            maxTicksLimit: false,
                            font: {
                                size: filtroActualPagina === 'dia' ? 10 : 12
                            }
                        }
                    }
                }
            }
        };
        
        if (filtroActualPagina === 'dia') {
            chartConfig.data.datasets[0].pointBackgroundColor = '#0f9d79';
            chartConfig.data.datasets[0].pointBorderColor = '#fff';
            chartConfig.data.datasets[0].pointBorderWidth = 2;
            chartConfig.data.datasets[0].pointRadius = 5;
            chartConfig.data.datasets[0].pointHoverRadius = 7;
        } else {
            chartConfig.data.datasets[0].barThickness = 'flex';
        }
        
        new Chart(ctxPartidas, chartConfig);
    }

    const preguntasCategoriaData = {{{preguntasCategoriaJson}}};
    if (preguntasCategoriaData && preguntasCategoriaData.length > 0) {
        const ctxCategorias = document.getElementById('preguntasCategoriaChart').getContext('2d');
        const colores = ['#0f9d79', '#3b82f6', '#8b5cf6', '#ef4444', '#f59e0b', '#10b981', '#f97316', '#6366f1'];
        
        new Chart(ctxCategorias, {
            type: 'doughnut',
            data: {
                labels: preguntasCategoriaData.map(item => item.categoria),
                datasets: [{
                    data: preguntasCategoriaData.map(item => item.cantidad),
                    backgroundColor: colores.slice(0, preguntasCategoriaData.length),
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 1,
                plugins: {
                    legend: { 
                        position: 'bottom',
                        labels: { padding: 10, usePointStyle: true, boxWidth: 12 }
                    }
                }
            }
        });
    }
});

function descargarPDF() {
    const boton = event.target;
    const textoOriginal = boton.innerHTML;
    boton.innerHTML = '‚è≥ Generando PDF...';
    boton.disabled = true;

    try {
        const mainContent = document.querySelector('.adm-wrap');

        html2canvas(mainContent, {
            scale: 1.2,
            useCORS: true,
            allowTaint: true,
            backgroundColor: '#f3f4f6',
            width: mainContent.offsetWidth,
            height: mainContent.offsetHeight,
            scrollX: 0,
            scrollY: 0
        }).then(canvas => {
            
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            
            const imgWidth = pdfWidth - 20;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;

            let yPosition = 0;
            const pageHeight = pdfHeight - 20;
            
            while (yPosition < imgHeight) {
                pdf.addImage(imgData, 'PNG', 10, 10 - yPosition, imgWidth, imgHeight);
                yPosition += pageHeight;
                
                if (yPosition < imgHeight) {
                    pdf.addPage();
                }
            }

            const fecha = new Date().toISOString().split('T')[0];
            const year = document.getElementById('yearSelector').value || 'todos';
            pdf.save(`reporte-admin-${year}-${fecha}.pdf`);

            boton.innerHTML = '‚úÖ PDF Descargado';
            setTimeout(() => {
                boton.innerHTML = textoOriginal;
                boton.disabled = false;
            }, 2000);
            
        }).catch(error => {
            console.error('Error al generar PDF:', error);
            alert('Error al generar el PDF. Intente nuevamente.');
            boton.innerHTML = textoOriginal;
            boton.disabled = false;
        });
        
    } catch (error) {
        console.error('Error:', error);
        alert('Error al procesar la descarga del PDF.');
        boton.innerHTML = textoOriginal;
        boton.disabled = false;
    }
}
</script>